/*
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */
(function(a,b){if(typeof exports==="object"&&exports){b(exports)}else{var c={};b(c);if(typeof define==="function"&&define.amd){define(c)}else{a.Mustache=c}}}(this,function(a){var e=/\s*/;var l=/\s+/;var j=/\S/;var h=/\s*=/;var n=/\s*\}/;var t=/#|\^|\/|>|\{|&|=|!/;var f=RegExp.prototype.test;function s(z,y){return f.call(z,y)}function g(y){return !s(j,y)}var v=Object.prototype.toString;var k=Array.isArray||function(y){return v.call(y)==="[object Array]"};function d(y){return y.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function m(y){return String(y).replace(/[&<>"'\/]/g,function(z){return c[z]})}function u(y){this.string=y;this.tail=y;this.pos=0}u.prototype.eos=function(){return this.tail===""};u.prototype.scan=function(z){var y=this.tail.match(z);if(y&&y.index===0){this.tail=this.tail.substring(y[0].length);this.pos+=y[0].length;return y[0]}return""};u.prototype.scanUntil=function(z){var y,A=this.tail.search(z);switch(A){case -1:y=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:y="";break;default:y=this.tail.substring(0,A);this.tail=this.tail.substring(A);this.pos+=A}return y};function r(y,z){this.view=y||{};this.parent=z;this._cache={}}r.make=function(y){return(y instanceof r)?y:new r(y)};r.prototype.push=function(y){return new r(y,this)};r.prototype.lookup=function(y){var B=this._cache[y];if(!B){if(y=="."){B=this.view}else{var A=this;while(A){if(y.indexOf(".")>0){B=A.view;var C=y.split("."),z=0;while(B&&z<C.length){B=B[C[z++]]}}else{B=A.view[y]}if(B!=null){break}A=A.parent}}this._cache[y]=B}if(typeof B==="function"){B=B.call(this.view)}return B};function p(){this.clearCache()}p.prototype.clearCache=function(){this._cache={};this._partialCache={}};p.prototype.compile=function(A,y){var z=this._cache[A];if(!z){var B=a.parse(A,y);z=this._cache[A]=this.compileTokens(B,A)}return z};p.prototype.compilePartial=function(z,B,y){var A=this.compile(B,y);this._partialCache[z]=A;return A};p.prototype.getPartial=function(y){if(!(y in this._partialCache)&&this._loadPartial){this.compilePartial(y,this._loadPartial(y))}return this._partialCache[y]};p.prototype.compileTokens=function(A,z){var y=this;return function(B,D){if(D){if(typeof D==="function"){y._loadPartial=D}else{for(var C in D){y.compilePartial(C,D[C])}}}return o(A,y,r.make(B),z)}};p.prototype.render=function(A,y,z){return this.compile(A)(y,z)};function o(F,z,y,I){var C="";var A,G,H;for(var D=0,E=F.length;D<E;++D){A=F[D];G=A[1];switch(A[0]){case"#":H=y.lookup(G);if(typeof H==="object"){if(k(H)){for(var B=0,K=H.length;B<K;++B){C+=o(A[4],z,y.push(H[B]),I)}}else{if(H){C+=o(A[4],z,y.push(H),I)}}}else{if(typeof H==="function"){var J=I==null?null:I.slice(A[3],A[5]);H=H.call(y.view,J,function(M){return z.render(M,y)});if(H!=null){C+=H}}else{if(H){C+=o(A[4],z,y,I)}}}break;case"^":H=y.lookup(G);if(!H||(k(H)&&H.length===0)){C+=o(A[4],z,y,I)}break;case">":H=z.getPartial(G);if(typeof H==="function"){C+=H(y)}break;case"&":H=y.lookup(G);if(H!=null){C+=H}break;case"name":H=y.lookup(G);if(H!=null){C+=a.escape(H)}break;case"text":C+=G;break}}return C}function x(E){var z=[];var D=z;var F=[];var B;for(var A=0,y=E.length;A<y;++A){B=E[A];switch(B[0]){case"#":case"^":F.push(B);D.push(B);D=B[4]=[];break;case"/":var C=F.pop();C[5]=B[2];D=F.length>0?F[F.length-1][4]:z;break;default:D.push(B)}}return z}function b(D){var A=[];var C,z;for(var B=0,y=D.length;B<y;++B){C=D[B];if(C){if(C[0]==="text"&&z&&z[0]==="text"){z[1]+=C[1];z[3]=C[3]}else{z=C;A.push(C)}}}return A}function q(y){return[new RegExp(d(y[0])+"\\s*"),new RegExp("\\s*"+d(y[1]))]}function w(P,E){P=P||"";E=E||a.tags;if(typeof E==="string"){E=E.split(l)}if(E.length!==2){throw new Error("Invalid tags: "+E.join(", "))}var I=q(E);var A=new u(P);var G=[];var F=[];var D=[];var Q=false;var O=false;function N(){if(Q&&!O){while(D.length){delete F[D.pop()]}}else{D=[]}Q=false;O=false}var B,z,H,J,C;while(!A.eos()){B=A.pos;H=A.scanUntil(I[0]);if(H){for(var K=0,M=H.length;K<M;++K){J=H.charAt(K);if(g(J)){D.push(F.length)}else{O=true}F.push(["text",J,B,B+1]);B+=1;if(J=="\n"){N()}}}if(!A.scan(I[0])){break}Q=true;z=A.scan(t)||"name";A.scan(e);if(z==="="){H=A.scanUntil(h);A.scan(h);A.scanUntil(I[1])}else{if(z==="{"){H=A.scanUntil(new RegExp("\\s*"+d("}"+E[1])));A.scan(n);A.scanUntil(I[1]);z="&"}else{H=A.scanUntil(I[1])}}if(!A.scan(I[1])){throw new Error("Unclosed tag at "+A.pos)}C=[z,H,B,A.pos];F.push(C);if(z==="#"||z==="^"){G.push(C)}else{if(z==="/"){if(G.length===0){throw new Error('Unopened section "'+H+'" at '+B)}var y=G.pop();if(y[1]!==H){throw new Error('Unclosed section "'+y[1]+'" at '+B)}}else{if(z==="name"||z==="{"||z==="&"){O=true}else{if(z==="="){E=H.split(l);if(E.length!==2){throw new Error("Invalid tags at "+B+": "+E.join(", "))}I=q(E)}}}}}var y=G.pop();if(y){throw new Error('Unclosed section "'+y[1]+'" at '+A.pos)}F=b(F);return x(F)}a.name="mustache.js";a.version="0.7.2";a.tags=["{{","}}"];a.Scanner=u;a.Context=r;a.Writer=p;a.parse=w;a.escape=m;var i=new p();a.clearCache=function(){return i.clearCache()};a.compile=function(z,y){return i.compile(z,y)};a.compilePartial=function(z,A,y){return i.compilePartial(z,A,y)};a.compileTokens=function(z,y){return i.compileTokens(z,y)};a.render=function(A,y,z){return i.render(A,y,z)};a.to_html=function(B,z,A,C){var y=a.render(B,z,A);if(typeof C==="function"){C(y)}else{return y}}}));var OP={};(function(b,a){a.viewmodel={};a.view={};b.extend(a.viewmodel,{version:0.1});b.extend(a.view,{$document:null});a.loader={};b.extend(a.loader,{init:function(){this.setDomOptions();this.bindEvents();this.initModules()},initModules:function(){try{a.search.init();a.map.init();a.osm.geocoder.init()}catch(c){alert(c)}},bindEvents:function(){a.view.$document.on("keyup",function(c){if(c.keyCode===27){a.view.$document.trigger("/op/escape")}})},setDomOptions:function(){a.view.$document=b(document)}});b(document).ready(function(){a.loader.init()})})(jQuery,OP);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{$searchResults:null});a.search={};b.extend(a.search,{init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){var c=this;b("#addressSearch input.address").off("keyup").on("keyup",function(d){c.manageSearchInputs(d,this.value)});a.view.$document.on("/op/search/clearSearchResults",function(){c.clearSearchResults()});a.view.$document.on("/op/escape",function(){c.clearSearchResults()})},searchInputHandler:[],manageSearchInputs:function(d,e){if(d.keyCode===27){this.clearSearchResults();this.searchInputHandler=[];this.isSearchResultsExist=false;return false}var c=this;this.searchInputHandler.push([d,e]);setTimeout(function(){var f=c.searchInputHandler.length;if(f>1){c.searchInputHandler.splice(0,1)}else{if(f===1){c.searchKeyHandler(c.searchInputHandler[0][0],c.searchInputHandler[0][1]);c.searchInputHandler.splice(0,1)}}},1000)},isSearchResultsExist:false,searchKeyHandler:function(c,d){var e=c.keyCode;if(e===13){c.preventDefault()}if(this.validateSearch(d)){this.search(d)}else{if(this.isSearchResultsExist){this.clearSearchResults()}}},clearSearchResults:function(){a.view.$searchResults.empty();this.isSearchResultsExist=false},validateSearch:function(c){if(b.trim(c)===""){return false}if(c.length<4){return false}return true},countSearchResultsVisible:7,search:function(c){var d=this,e,f=0;a.view.$searchResults.empty().addClass("loader");a.view.$document.trigger("/op/osm/geocoder/direct",[c,function(g){e=g.matches;if(e){f=g.matches.length;if(f>d.countSearchResultsVisible){e=e.slice(0,d.countSearchResultsVisible)}}a.view.$searchResults.removeClass("loader");d.isSearchResultsExist=true;a.view.$searchResults.append(a.templates["search-item"]({matches:e}));d.bindEventsAfterSearch(f)}])},bindEventsAfterSearch:function(d){var c=this;if(d>0){a.view.$searchResults.find("li.address").off("click").on("click",function(g){var f=b(this);c.clearSearchResults();a.view.$document.trigger("/op/map/setview",[f.data("lat"),f.data("lng")])})}else{a.view.$searchResults.find("ul").delay(1000).fadeOut(1000)}},setDomOptions:function(){a.view.$searchResults=b("#searchResults")}})})(jQuery,OP);(function(b,a){b.extend(a.viewmodel,{map:null});b.extend(a.view,{$map:null});a.map={};b.extend(a.map,{defaultExtent:{latlng:new L.LatLng(55.742,37.658),zoom:14},init:function(){this.buildMap();this.buildOsmTileLayer();this.bindEvents()},buildMap:function(){var d=a.viewmodel,c=this.getLastExtent();a.view.$map=b("#map");d.map=new L.Map("map");L.control.scale().addTo(d.map);if(c){d.map.setView(c.latlng,c.zoom)}else{d.map.setView(this.defaultExtent.latlng,this.defaultExtent.zoom);this.setLastExtent(this.defaultExtent.latlng,this.defaultExtent.zoom)}},buildOsmTileLayer:function(){this.addTileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png","© OpenStreetMap contributors",8,18)},addTileLayer:function(e,d,g,c){var f=new L.TileLayer(e,{minZoom:g,maxZoom:c,attribution:d});a.viewmodel.map.addLayer(f,true)},getLastExtent:function(){var e=parseFloat(b.cookie("map.lat"),10),c=parseFloat(b.cookie("map.lng"),10),d=parseInt(b.cookie("map.zoom"),10);if(e&&c&&d){return{latlng:new L.LatLng(e,c),zoom:d}}else{return null}},setLastExtent:function(d,c){b.cookie("map.lat",d.lat,{expires:7,path:"/"});b.cookie("map.lng",d.lng,{expires:7,path:"/"});b.cookie("map.zoom",c,{expires:7,path:"/"})},bindEvents:function(){a.view.$document.on("/op/map/setview",function(e,f,c,d){if(!d){d=18}a.viewmodel.map.setView(new L.LatLng(f,c),18);b("#target").show().delay(1000).fadeOut(1000)});a.viewmodel.map.on("click",function(){a.view.$document.trigger("/op/search/clearSearchResults")})}})})(jQuery,OP);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{});a.osm={};a.osm.geocoder={};b.extend(a.osm.geocoder,{init:function(){this.bindEvents()},bindEvents:function(){var c=this;a.view.$document.on("/op/osm/geocoder/direct",function(e,d,f){c.directGeocode(d,f)})},directGeocode:function(c,d){b.getJSON("http://beta.openstreetmap.ru/api/search?q="+c,function(e){d(e)})}})})(jQuery,OP);OP.templates={};OP.templates["search-item"]=Mustache.compile('<ul class="search-block"> {{#matches}} <li class="address" data-lat={{lat}} data-lng={{lon}}>{{display_name}}</li> {{/matches}} {{^matches}} <li class="empty-result">Адрес не найден</li> {{/matches}} </ul>');