/*
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */
(function(a,b){if(typeof exports==="object"&&exports){b(exports)}else{var c={};b(c);if(typeof define==="function"&&define.amd){define(c)}else{a.Mustache=c}}}(this,function(a){var e=/\s*/;var l=/\s+/;var j=/\S/;var h=/\s*=/;var n=/\s*\}/;var t=/#|\^|\/|>|\{|&|=|!/;var f=RegExp.prototype.test;function s(z,y){return f.call(z,y)}function g(y){return !s(j,y)}var v=Object.prototype.toString;var k=Array.isArray||function(y){return v.call(y)==="[object Array]"};function d(y){return y.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function m(y){return String(y).replace(/[&<>"'\/]/g,function(z){return c[z]})}function u(y){this.string=y;this.tail=y;this.pos=0}u.prototype.eos=function(){return this.tail===""};u.prototype.scan=function(z){var y=this.tail.match(z);if(y&&y.index===0){this.tail=this.tail.substring(y[0].length);this.pos+=y[0].length;return y[0]}return""};u.prototype.scanUntil=function(z){var y,A=this.tail.search(z);switch(A){case -1:y=this.tail;this.pos+=this.tail.length;this.tail="";break;case 0:y="";break;default:y=this.tail.substring(0,A);this.tail=this.tail.substring(A);this.pos+=A}return y};function r(y,z){this.view=y||{};this.parent=z;this._cache={}}r.make=function(y){return(y instanceof r)?y:new r(y)};r.prototype.push=function(y){return new r(y,this)};r.prototype.lookup=function(y){var B=this._cache[y];if(!B){if(y=="."){B=this.view}else{var A=this;while(A){if(y.indexOf(".")>0){B=A.view;var C=y.split("."),z=0;while(B&&z<C.length){B=B[C[z++]]}}else{B=A.view[y]}if(B!=null){break}A=A.parent}}this._cache[y]=B}if(typeof B==="function"){B=B.call(this.view)}return B};function p(){this.clearCache()}p.prototype.clearCache=function(){this._cache={};this._partialCache={}};p.prototype.compile=function(A,y){var z=this._cache[A];if(!z){var B=a.parse(A,y);z=this._cache[A]=this.compileTokens(B,A)}return z};p.prototype.compilePartial=function(z,B,y){var A=this.compile(B,y);this._partialCache[z]=A;return A};p.prototype.getPartial=function(y){if(!(y in this._partialCache)&&this._loadPartial){this.compilePartial(y,this._loadPartial(y))}return this._partialCache[y]};p.prototype.compileTokens=function(A,z){var y=this;return function(B,D){if(D){if(typeof D==="function"){y._loadPartial=D}else{for(var C in D){y.compilePartial(C,D[C])}}}return o(A,y,r.make(B),z)}};p.prototype.render=function(A,y,z){return this.compile(A)(y,z)};function o(F,z,y,I){var C="";var A,G,H;for(var D=0,E=F.length;D<E;++D){A=F[D];G=A[1];switch(A[0]){case"#":H=y.lookup(G);if(typeof H==="object"){if(k(H)){for(var B=0,K=H.length;B<K;++B){C+=o(A[4],z,y.push(H[B]),I)}}else{if(H){C+=o(A[4],z,y.push(H),I)}}}else{if(typeof H==="function"){var J=I==null?null:I.slice(A[3],A[5]);H=H.call(y.view,J,function(M){return z.render(M,y)});if(H!=null){C+=H}}else{if(H){C+=o(A[4],z,y,I)}}}break;case"^":H=y.lookup(G);if(!H||(k(H)&&H.length===0)){C+=o(A[4],z,y,I)}break;case">":H=z.getPartial(G);if(typeof H==="function"){C+=H(y)}break;case"&":H=y.lookup(G);if(H!=null){C+=H}break;case"name":H=y.lookup(G);if(H!=null){C+=a.escape(H)}break;case"text":C+=G;break}}return C}function x(E){var z=[];var D=z;var F=[];var B;for(var A=0,y=E.length;A<y;++A){B=E[A];switch(B[0]){case"#":case"^":F.push(B);D.push(B);D=B[4]=[];break;case"/":var C=F.pop();C[5]=B[2];D=F.length>0?F[F.length-1][4]:z;break;default:D.push(B)}}return z}function b(D){var A=[];var C,z;for(var B=0,y=D.length;B<y;++B){C=D[B];if(C){if(C[0]==="text"&&z&&z[0]==="text"){z[1]+=C[1];z[3]=C[3]}else{z=C;A.push(C)}}}return A}function q(y){return[new RegExp(d(y[0])+"\\s*"),new RegExp("\\s*"+d(y[1]))]}function w(P,E){P=P||"";E=E||a.tags;if(typeof E==="string"){E=E.split(l)}if(E.length!==2){throw new Error("Invalid tags: "+E.join(", "))}var I=q(E);var A=new u(P);var G=[];var F=[];var D=[];var Q=false;var O=false;function N(){if(Q&&!O){while(D.length){delete F[D.pop()]}}else{D=[]}Q=false;O=false}var B,z,H,J,C;while(!A.eos()){B=A.pos;H=A.scanUntil(I[0]);if(H){for(var K=0,M=H.length;K<M;++K){J=H.charAt(K);if(g(J)){D.push(F.length)}else{O=true}F.push(["text",J,B,B+1]);B+=1;if(J=="\n"){N()}}}if(!A.scan(I[0])){break}Q=true;z=A.scan(t)||"name";A.scan(e);if(z==="="){H=A.scanUntil(h);A.scan(h);A.scanUntil(I[1])}else{if(z==="{"){H=A.scanUntil(new RegExp("\\s*"+d("}"+E[1])));A.scan(n);A.scanUntil(I[1]);z="&"}else{H=A.scanUntil(I[1])}}if(!A.scan(I[1])){throw new Error("Unclosed tag at "+A.pos)}C=[z,H,B,A.pos];F.push(C);if(z==="#"||z==="^"){G.push(C)}else{if(z==="/"){if(G.length===0){throw new Error('Unopened section "'+H+'" at '+B)}var y=G.pop();if(y[1]!==H){throw new Error('Unclosed section "'+y[1]+'" at '+B)}}else{if(z==="name"||z==="{"||z==="&"){O=true}else{if(z==="="){E=H.split(l);if(E.length!==2){throw new Error("Invalid tags at "+B+": "+E.join(", "))}I=q(E)}}}}}var y=G.pop();if(y){throw new Error('Unclosed section "'+y[1]+'" at '+A.pos)}F=b(F);return x(F)}a.name="mustache.js";a.version="0.7.2";a.tags=["{{","}}"];a.Scanner=u;a.Context=r;a.Writer=p;a.parse=w;a.escape=m;var i=new p();a.clearCache=function(){return i.clearCache()};a.compile=function(z,y){return i.compile(z,y)};a.compilePartial=function(z,A,y){return i.compilePartial(z,A,y)};a.compileTokens=function(z,y){return i.compileTokens(z,y)};a.render=function(A,y,z){return i.render(A,y,z)};a.to_html=function(B,z,A,C){var y=a.render(B,z,A);if(typeof C==="function"){C(y)}else{return y}}}));
/*
 * jQuery Cookie Plugin v1.3.1
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2013 Klaus Hartl
 * Released under the MIT license
 */
(function(a){if(typeof define==="function"&&define.amd){define(["jquery"],a)}else{a(jQuery)}}(function(e){var a=/\+/g;function d(g){return g}function b(g){return decodeURIComponent(g.replace(a," "))}function f(g){if(g.indexOf('"')===0){g=g.slice(1,-1).replace(/\\"/g,'"').replace(/\\\\/g,"\\")}try{return c.json?JSON.parse(g):g}catch(h){}}var c=e.cookie=function(p,o,u){if(o!==undefined){u=e.extend({},c.defaults,u);if(typeof u.expires==="number"){var q=u.expires,s=u.expires=new Date();s.setDate(s.getDate()+q)}o=c.json?JSON.stringify(o):String(o);return(document.cookie=[c.raw?p:encodeURIComponent(p),"=",c.raw?o:encodeURIComponent(o),u.expires?"; expires="+u.expires.toUTCString():"",u.path?"; path="+u.path:"",u.domain?"; domain="+u.domain:"",u.secure?"; secure":""].join(""))}var g=c.raw?d:b;var r=document.cookie.split("; ");var v=p?undefined:{};for(var n=0,k=r.length;n<k;n++){var m=r[n].split("=");var h=g(m.shift());var j=g(m.join("="));if(p&&p===h){v=f(j);break}if(!p){v[h]=f(j)}}return v};c.defaults={};e.removeCookie=function(h,g){if(e.cookie(h)!==undefined){e.cookie(h,"",e.extend(g,{expires:-1}));return true}return false}}));var OP={};(function(b,a){a.viewmodel={};a.view={};b.extend(a.viewmodel,{version:0.1});b.extend(a.view,{$document:null,$body:null});a.loader={};b.extend(a.loader,{init:function(){this.setDomOptions();this.bindEvents();this.initModules()},initModules:function(){try{a.search.init();a.permalink.init();a.map.init();a.houses.init();a.houses.legend.init();a.osm.geocoder.init()}catch(c){alert(c)}},bindEvents:function(){a.view.$document.on("keyup",function(c){if(c.keyCode===27){a.view.$document.trigger("/op/escape")}})},setDomOptions:function(){a.view.$document=b(document);a.view.$body=b("body")}});b(document).ready(function(){a.loader.init()})})(jQuery,OP);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{$searchResults:null});a.search={};b.extend(a.search,{init:function(){this.setDomOptions();this.bindEvents()},bindEvents:function(){var c=this;b("#addressSearch input.address").off("keyup").on("keyup",function(d){c.manageSearchInputs(d,this.value)});b("#addressSearchForm").submit(function(d){d.preventDefault()});b("#addressSearchForm input.find").off("click").on("click",function(d){c.search(b("#address").val(),"searchByEnter")});a.view.$document.on("/op/search/clearSearchResults",function(){c.clearSearchResults()});a.view.$document.on("/op/escape",function(){c.clearSearchResults()})},timeout:null,manageSearchInputs:function(e,f){var d=this,c=e.keyCode||e.which;if(c===13){this.search(f,"searchByEnter")}if(this.timeout){clearTimeout(this.timeout);this.timeout=null}this.timeout=setTimeout(function(){clearTimeout(d.timeout);d.timeout=null;d.searchKeyHandler(e,f)},1000)},isSearchResultsExist:false,searchKeyHandler:function(c,d){if(this.validateSearch(d)){this.search(d,"searchByChar")}else{if(this.isSearchResultsExist){this.clearSearchResults()}}},clearSearchResults:function(){a.view.$searchResults.empty();this.isSearchResultsExist=false},validateSearch:function(c){if(b.trim(c)===""){return false}if(c.length<4){return false}return true},countSearchResultsVisible:7,search:function(c,e){var d=this,f;c=this.prepareSearch(c);a.view.$searchResults.empty().addClass("loader");a.view.$document.trigger("/op/osm/geocoder/direct",[c,function(g){a.view.$searchResults.removeClass("loader");f=g.matches;d[e](f)}])},searchByChar:function(c){var d=0;if(c){d=c.length;if(d>this.countSearchResultsVisible){c=c.slice(0,this.countSearchResultsVisible)}}this.buildSearchResults(c);this.bindEventsAfterSearch(d)},searchByEnter:function(c){if(c){this.goToSearchedAddress(c[0].lat,c[0].lon)}else{this.buildSearchResults(null)}},buildSearchResults:function(c){a.view.$searchResults.empty().append(a.templates["search-item"]({matches:c}))},prepareSearch:function(c){return"Москва, "+c},bindEventsAfterSearch:function(d){var c=this;if(d>0){a.view.$searchResults.find("li.address").off("click").on("click",function(g){var f=b(this);c.goToSearchedAddress(f.data("lat"),f.data("lng"))})}else{this.showNotFoundResults()}},goToSearchedAddress:function(d,c){this.clearSearchResults();a.viewmodel.map.closePopup();a.view.$document.trigger("/op/map/setview",[d,c])},showNotFoundResults:function(){a.view.$searchResults.find("ul").delay(1000).fadeOut(1000)},setDomOptions:function(){a.view.$searchResults=b("#searchResults")}})})(jQuery,OP);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{$permalink:null});a.permalink={};b.extend(a.permalink,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){a.view.$permalink=b("#permalink")},bindEvents:function(){a.view.$document.on("/op/permalink/update",function(d,e,c){a.view.$permalink.prop("href",document.url_root+"?lat="+e.lat+"&lng="+e.lng+"&z="+c)})}})})(jQuery,OP);(function(b,a){b.extend(a.viewmodel,{map:null});b.extend(a.view,{$map:null});a.map={};b.extend(a.map,{defaultExtent:{latlng:new L.LatLng(55.742,37.658),zoom:17},init:function(){this.buildMap();this.buildOsmTileLayer();this.bindEvents()},buildMap:function(){var e=a.viewmodel,d=this.getExtentFromUrl(),c;a.view.$map=b("#map");e.map=new L.Map("map",{minZoom:17});L.control.scale().addTo(e.map);if(d){e.map.setView(d.latlng,d.zoom);this.setLastExtent(d.latlng,d.zoom)}else{c=this.getLastExtent();if(c){e.map.setView(c.latlng,c.zoom)}else{e.map.setView(this.defaultExtent.latlng,this.defaultExtent.zoom);this.setLastExtent(this.defaultExtent.latlng,this.defaultExtent.zoom)}}a.view.$document.trigger("/op/permalink/update",[e.map.getCenter(),e.map.getZoom()])},buildOsmTileLayer:function(){this.addTileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png","© OpenStreetMap contributors",8,18)},addTileLayer:function(e,d,g,c){var f=new L.TileLayer(e,{minZoom:g,maxZoom:c,attribution:d});a.viewmodel.map.addLayer(f,true)},getLastExtent:function(){var e=parseFloat(b.cookie("map.lat"),10),c=parseFloat(b.cookie("map.lng"),10),d=parseInt(b.cookie("map.zoom"),10);if(e&&c&&d){return{latlng:new L.LatLng(e,c),zoom:d}}else{return null}},setLastExtent:function(d,c){b.cookie("map.lat",d.lat,{expires:7,path:"/"});b.cookie("map.lng",d.lng,{expires:7,path:"/"});b.cookie("map.zoom",c,{expires:7,path:"/"})},getExtentFromUrl:function(){var e=parseFloat(this.getURLParameter("lat")),c=parseFloat(this.getURLParameter("lng")),d=parseFloat(this.getURLParameter("z"));if(e&&c&&d){return{latlng:new L.LatLng(e,c),zoom:d}}return null},getURLParameter:function(c){return decodeURI((RegExp(c+"=(.+?)(&|$)").exec(location.search)||[,null])[1])},bindEvents:function(){var c=this;a.viewmodel.map.on("moveend",function(){var d=a.viewmodel.map;c.setLastExtent(d.getCenter(),d.getZoom());a.view.$document.trigger("/op/map/moveend");a.view.$document.trigger("/op/permalink/update",[this.getCenter(),this.getZoom()])});a.view.$document.on("/op/map/setview",function(f,g,d,e){if(!e){e=18}a.viewmodel.map.setView(new L.LatLng(g,d),18);b("#target").show().delay(1000).fadeOut(1000)});a.viewmodel.map.on("click",function(){a.view.$document.trigger("/op/search/clearSearchResults")})}})})(jQuery,OP);(function(b,a){b.extend(a.viewmodel,{housesLayer:null,policemen:[]});b.extend(a.view,{});a.houses={};b.extend(a.houses,{init:function(){this.bindEvents();this.buildHousesLayer();this.updateHousesLayer()},bindEvents:function(){var c=this;a.view.$document.on("/op/map/moveend",function(){c.updateHousesLayer()})},buildHousesLayer:function(){var c=a.viewmodel;c.housesLayer=L.geoJson(null,{onEachFeature:this.bindFeatureEvents,style:this.setStyle}).addTo(c.map)},bindFeatureEvents:function(d,c){c.on("click",function(f){var g=a.viewmodel.map,i=f.latlng,h=a.viewmodel.policemen[d.properties.pm_id],e=a.templates["house-popup"]({policeman:h,address:d.properties.address});g.panTo(i);g.openPopup(L.popup().setLatLng(i).setContent(e));g.panBy([0,-100])})},setStyle:function(c){return{color:a.viewmodel.policemen[c.properties.pm_id].color,opacity:1,weight:3}},updateHousesLayer:function(){var c=a.viewmodel;if(!this.validateMap(c.map)){return false}a.view.$searchResults.empty().addClass("loader");c.policemen=[];this.ajaxGetHouses()},validateMap:function(c){return c.getZoom()>16},ajaxGetHouses:function(){var c=document.url_root+"houses";b.ajax({type:"GET",url:c,data:{box:JSON.stringify(a.viewmodel.map.getBounds())},dataType:"json",success:function(e){var f=a.viewmodel,d=a.view;f.policemen=e.policemen;f.housesLayer.clearLayers();f.housesLayer.addData(e.houses);d.$searchResults.empty().removeClass("loader");d.$document.trigger("/op/houses/updated")}})}})})(jQuery,OP);(function(b,a){b.extend(a.viewmodel,{searcherCollapsed:false});b.extend(a.view,{$legend:null,$symbols:null});a.houses.legend={};b.extend(a.houses.legend,{init:function(){this.setDomOptions();this.bindEvents()},setDomOptions:function(){var c=a.view;c.$legend=b("#legend");c.$symbols=c.$legend.find("div.symbols")},bindEvents:function(){var c=this;a.view.$legend.find("span.icon-collapse, div.title").off("click").on("click",function(){a.viewmodel.searcherCollapsed=!a.viewmodel.searcherCollapsed;a.view.$body.toggleClass("searcher-collapsed",a.viewmodel.searcherCollapsed)});a.view.$document.on("/op/houses/updated",function(){c.buildLegend()})},buildLegend:function(){var c=a.view.$symbols,e=a.viewmodel.policemen,d=[],f;for(f in e){if(e.hasOwnProperty(f)){d.push({name:e[f].name,color:e[f].color})}}c.empty().append(a.templates["policemen-symbols"]({policemen:d}))}})})(jQuery,OP);(function(b,a){b.extend(a.viewmodel,{});b.extend(a.view,{});a.osm={};a.osm.geocoder={};b.extend(a.osm.geocoder,{init:function(){this.bindEvents()},bindEvents:function(){var c=this;a.view.$document.on("/op/osm/geocoder/direct",function(e,d,f){c.directGeocode(d,f)})},directGeocode:function(d,e){var c="http://beta.openstreetmap.ru/api/search?callback=?&q="+d;b.ajax({type:"GET",url:c,async:false,jsonpCallback:"jsonCallback",contentType:"application/json",dataType:"jsonp",success:function(f){e(f)}})}})})(jQuery,OP);OP.templates={};OP.templates["search-item"]=Mustache.compile('<ul class="search-block"> {{#matches}} <li class="address" data-lat={{lat}} data-lng={{lon}}>{{display_name}}</li> {{/matches}} {{^matches}} <li class="empty-result">Адрес не найден</li> {{/matches}} </ul>');OP.templates["policemen-symbols"]=Mustache.compile('<ul> {{#policemen}} <li> <div style="border-color: {{color}}"><span style="background-color: {{color}}"></span></div> {{name}} </li> {{/policemen}} {{^policemen}} <li> Ответственных участковых для этого участка не найдено </li> {{/policemen}} </ul>');OP.templates["house-popup"]=Mustache.compile('<img src="{{policeman.photo_url}}"/> <table id="popup" class="table table-striped"> <tr> <td>ФИО</td> <td>{{policeman.name}}</td> </tr> <tr> <td>Должность</td> <td>{{policeman.type}}</td> </tr> <tr> <td>Звание</td> <td>{{policeman.rank}}</td> </tr> <tr> <td>Телефон</td> <td>{{policeman.phone}}</td> </tr> <tr> <td>Ссылка</td> <td><a title="Страница полицейского на 112.ru" href="{{policeman.url}}" target="_blank">112.ru</a></td> </tr> <tr> <td>Адрес</td> <td>{{address}}</td> </tr> </table>');